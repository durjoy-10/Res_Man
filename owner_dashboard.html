<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Owner Dashboard</title>
    <link rel="stylesheet" href="static/css/owner_dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <script>
        // Simple auth check
        if (localStorage.getItem('ownerLoggedIn') !== 'true') {
            window.location.href = 'owner_login.html';
        }
        
        // Simple logout function
        function logout() {
            localStorage.removeItem('ownerLoggedIn');
            localStorage.removeItem('ownerId');
            localStorage.removeItem('restaurantId');
            localStorage.removeItem('ownerName');
            window.location.href = 'owner_login.html';
        }
    </script>
    
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-utensils"></i> Owner Panel</h2>
                <p>Welcome, <span id="ownerName"></span></p>
            </div>
            
            <nav class="sidebar-nav">
                <ul>
                    <li class="active" onclick="switchTab('dashboard')">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </li>
                    <li onclick="switchTab('menu')">
                        <i class="fas fa-utensils"></i> Menu Management
                    </li>
                    <li onclick="switchTab('orders')">
                        <i class="fas fa-shopping-bag"></i> Orders
                    </li>
                    <li onclick="switchTab('offers')">
                        <i class="fas fa-percentage"></i> Special Offers
                    </li>
                    <li onclick="switchTab('settings')">
                        <i class="fas fa-cog"></i> Restaurant Settings
                    </li>
                </ul>
            </nav>
            
            <div class="sidebar-footer">
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <div class="content-header">
                    <h1><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h1>
                </div>
                
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-icon bg-primary">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="today-orders">0</h3>
                            <p>Today's Orders</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon bg-warning">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="pending-orders">0</h3>
                            <p>Pending Orders</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon bg-success">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-revenue">$0</h3>
                            <p>This Month's Revenue</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon bg-info">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="menu-items">0</h3>
                            <p>Menu Items</p>
                        </div>
                    </div>
                </div>
                
                <div class="recent-orders">
                    <h2><i class="fas fa-history"></i> Recent Orders</h2>
                    <div class="orders-list" id="recent-orders-list">
                        <!-- Orders will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Menu Management Tab -->
            <div id="menu-tab" class="tab-content">
                <div class="content-header">
                    <h1><i class="fas fa-utensils"></i> Menu Management</h1>
                    <button class="btn btn-primary" onclick="addCategory()">
                        <i class="fas fa-plus"></i> Add Category
                    </button>
                </div>
                
                <div id="categories-container">
                    <!-- Categories will be loaded here -->
                </div>
            </div>
            
            <!-- Orders Tab -->
            <div id="orders-tab" class="tab-content">
                <div class="content-header">
                    <h1><i class="fas fa-shopping-bag"></i> Orders Management</h1>
                    <div class="order-filters">
                        <select id="order-status-filter" onchange="loadOrders()">
                            <option value="all">All Orders</option>
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                        <input type="text" id="order-search" placeholder="Search orders..." onkeyup="loadOrders()">
                    </div>
                </div>
                
                <div class="orders-list" id="orders-list">
                    <!-- Orders will be loaded here -->
                </div>
            </div>
            
            <!-- Offers Tab -->
            <div id="offers-tab" class="tab-content">
                <div class="content-header">
                    <h1><i class="fas fa-percentage"></i> Special Offers</h1>
                    <button class="btn btn-primary" onclick="addOffer()">
                        <i class="fas fa-plus"></i> Add Offer
                    </button>
                </div>
                
                <div id="offers-container">
                    <!-- Offers will be loaded here -->
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content">
                <div class="content-header">
                    <h1><i class="fas fa-cog"></i> Restaurant Settings</h1>
                </div>
                
                <form id="restaurant-settings-form" enctype="multipart/form-data">
                    <input type="hidden" id="restaurant-id" name="restaurant_id">
                    
                    <div class="form-section">
                        <h2><i class="fas fa-info-circle"></i> Basic Information</h2>
                        
                        <div class="form-group">
                            <label for="restaurant-name"><i class="fas fa-signature"></i> Restaurant Name</label>
                            <input type="text" id="restaurant-name" name="name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="restaurant-desc"><i class="fas fa-align-left"></i> Description</label>
                            <textarea id="restaurant-desc" name="description" rows="3" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="phone"><i class="fas fa-phone"></i> Phone Number</label>
                            <input type="tel" id="phone" name="phone" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="address"><i class="fas fa-map-marker-alt"></i> Address</label>
                            <textarea id="address" name="address" rows="3" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="restaurant-image"><i class="fas fa-image"></i> Restaurant Image</label>
                            <input type="file" id="restaurant-image" name="restaurant_image" accept="image/*">
                            <div id="current-image-container">
                                <p>Current Image:</p>
                                <img id="current-image" src="" alt="Current restaurant image">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h2><i class="fas fa-user-tie"></i> Owner Information</h2>
                        
                        <div class="form-group">
                            <label for="owner-name"><i class="fas fa-user"></i> Owner Name</label>
                            <input type="text" id="owner-name" name="owner_name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="owner-email"><i class="fas fa-envelope"></i> Email</label>
                            <input type="email" id="owner-email" name="owner_email" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="owner-password"><i class="fas fa-lock"></i> Change Password</label>
                            <input type="password" id="owner-password" name="owner_password" placeholder="Leave blank to keep current">
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let categoryCounter = 0;
        let itemCounter = 0;
        const restaurantId = localStorage.getItem('restaurantId');
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Set owner name
            document.getElementById('ownerName').textContent = localStorage.getItem('ownerName');
            
            // Load initial data
            loadDashboardStats();
            loadRecentOrders();
            loadMenuCategories();
            loadOffers();
            loadRestaurantSettings();
        });
        
        // Tab switching
        function switchTab(tabName) {
            // Update active tab in sidebar
            document.querySelectorAll('.sidebar-nav li').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.sidebar-nav li[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // Update active content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Load data if needed
            if (tabName === 'orders') {
                loadOrders();
            } else if (tabName === 'dashboard') {
                loadDashboardStats();
                loadRecentOrders();
            }
        }
        
        // Dashboard functions
        function loadDashboardStats() {
            fetch(`get_owner_stats.php?restaurant_id=${restaurantId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('today-orders').textContent = data.today_orders;
                        document.getElementById('pending-orders').textContent = data.pending_orders;
                        document.getElementById('total-revenue').textContent = `$${data.monthly_revenue.toFixed(2)}`;
                        document.getElementById('menu-items').textContent = data.menu_items;
                    }
                })
                .catch(error => {
                    console.error('Error loading dashboard stats:', error);
                });
        }
        
        function loadRecentOrders() {
            fetch(`get_owner_orders.php?restaurant_id=${restaurantId}&limit=5`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('recent-orders-list');
                    container.innerHTML = '';
                    
                    if (data.success && data.data.length > 0) {
                        data.data.forEach(order => {
                            const orderElement = document.createElement('div');
                            orderElement.className = 'order-item';
                            orderElement.innerHTML = `
                                <div class="order-id">#${order.id}</div>
                                <div class="order-customer">${order.user_name}</div>
                                <div class="order-date">${new Date(order.order_date).toLocaleString()}</div>
                                <div class="order-status status-${order.status}">
                                    ${order.status.charAt(0).toUpperCase() + order.status.slice(1)}
                                </div>
                                <div class="order-total">$${parseFloat(order.total_amount).toFixed(2)}</div>
                            `;
                            container.appendChild(orderElement);
                        });
                    } else {
                        container.innerHTML = '<p>No recent orders found</p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading recent orders:', error);
                });
        }
        
        // Menu management functions
        function loadMenuCategories() {
            fetch(`get_menu_categories.php?restaurant_id=${restaurantId}`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('categories-container');
                    container.innerHTML = '';
                    
                    if (data.success && data.data.length > 0) {
                        data.data.forEach(category => {
                            addCategoryToUI(category);
                        });
                    } else {
                        container.innerHTML = '<p>No categories found. Add your first category!</p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading categories:', error);
                });
        }
        
        function addCategoryToUI(categoryData = null) {
            const categoryId = categoryData ? categoryData.id : `new-${categoryCounter++}`;
            const container = document.getElementById('categories-container');
            
            const categoryElement = document.createElement('div');
            categoryElement.className = 'category-card';
            categoryElement.id = `category-${categoryId}`;
            categoryElement.innerHTML = `
                <div class="category-header">
                    <input type="text" class="category-name" value="${categoryData?.name || 'New Category'}" 
                           placeholder="Category name" data-category-id="${categoryId}">
                    <div class="category-actions">
                        <button class="btn btn-primary" onclick="saveCategory('${categoryId}')">
                            <i class="fas fa-save"></i> Save
                        </button>
                        <button class="btn btn-danger" onclick="deleteCategory('${categoryId}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
                <div class="category-description">
                    <textarea placeholder="Category description" data-category-id="${categoryId}">${categoryData?.description || ''}</textarea>
                </div>
                <div class="items-header">
                    <h4><i class="fas fa-list"></i> Menu Items</h4>
                    <button class="btn btn-secondary" onclick="addMenuItem('${categoryId}')">
                        <i class="fas fa-plus"></i> Add Item
                    </button>
                </div>
                <div class="items-container" id="items-${categoryId}">
                    <!-- Items will be loaded here -->
                </div>
            `;
            
            container.appendChild(categoryElement);
            
            // Load items if category exists
            if (categoryData && categoryData.items) {
                categoryData.items.forEach(item => {
                    addMenuItemToUI(categoryId, item);
                });
            } else {
                // Add one empty item for new categories
                addMenuItemToUI(categoryId);
            }
        }
        
        function addMenuItemToUI(categoryId, itemData = null) {
            const itemId = itemData ? itemData.id : `new-${itemCounter++}`;
            const container = document.getElementById(`items-${categoryId}`);
            
            const itemElement = document.createElement('div');
            itemElement.className = 'menu-item';
            itemElement.id = `item-${itemId}`;
            itemElement.innerHTML = `
                <div class="item-row">
                    <div class="item-name">
                        <input type="text" placeholder="Item name" value="${itemData?.name || ''}" 
                               data-item-id="${itemId}" required>
                    </div>
                    <div class="item-price">
                        <input type="number" step="0.01" placeholder="Price" value="${itemData?.price || ''}" 
                               data-item-id="${itemId}" required>
                    </div>
                </div>
                <div class="item-row">
                    <div class="item-description">
                        <textarea placeholder="Item description" data-item-id="${itemId}">${itemData?.description || ''}</textarea>
                    </div>
                </div>
                <div class="item-row">
                    <div class="item-stock">
                        <label>Stock:</label>
                        <input type="number" value="${itemData?.stock || 0}" min="0" 
                               data-item-id="${itemId}" required>
                    </div>
                    <div class="item-image">
                        <label>Image:</label>
                        <input type="file" accept="image/*" data-item-id="${itemId}">
                        ${itemData?.image_path ? `<small>Current: ${itemData.image_path.split('/').pop()}</small>` : ''}
                    </div>
                </div>
                <div class="item-actions">
                    <button class="btn btn-primary" onclick="saveMenuItem('${categoryId}', '${itemId}')">
                        <i class="fas fa-save"></i> Save
                    </button>
                    <button class="btn btn-danger" onclick="deleteMenuItem('${categoryId}', '${itemId}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            `;
            
            container.appendChild(itemElement);
        }
        
        function saveCategory(categoryId) {
            const isNew = categoryId.startsWith('new-');
            const name = document.querySelector(`#category-${categoryId} .category-name`).value;
            const description = document.querySelector(`#category-${categoryId} .category-description textarea`).value;
            
            const formData = new FormData();
            formData.append('restaurant_id', restaurantId);
            formData.append('name', name);
            formData.append('description', description);
            
            if (isNew) {
                formData.append('is_new', '1');
            } else {
                formData.append('category_id', categoryId);
            }
            
            fetch('save_category.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Category saved successfully!', 'success');
                    if (isNew) {
                        // Reload categories to get proper IDs
                        loadMenuCategories();
                    }
                } else {
                    throw new Error(data.message || 'Failed to save category');
                }
            })
            .catch(error => {
                console.error('Error saving category:', error);
                showNotification(`Error: ${error.message}`, 'error');
            });
        }
        
        function deleteCategory(categoryId) {
            if (!confirm('Are you sure you want to delete this category and all its items?')) {
                return;
            }
            
            if (categoryId.startsWith('new-')) {
                // Just remove from UI if it's a new category
                document.getElementById(`category-${categoryId}`).remove();
                return;
            }
            
            fetch(`delete_category.php?category_id=${categoryId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Category deleted successfully!', 'success');
                    loadMenuCategories();
                } else {
                    throw new Error(data.message || 'Failed to delete category');
                }
            })
            .catch(error => {
                console.error('Error deleting category:', error);
                showNotification(`Error: ${error.message}`, 'error');
            });
        }
        
        function addMenuItem(categoryId) {
            addMenuItemToUI(categoryId);
        }
        
        function saveMenuItem(categoryId, itemId) {
            const isNew = itemId.startsWith('new-');
            const itemElement = document.getElementById(`item-${itemId}`);
            
            const name = itemElement.querySelector('[data-item-id]').value;
            const price = itemElement.querySelector('[type="number"]').value;
            const description = itemElement.querySelector('textarea').value;
            const stock = itemElement.querySelector('[min="0"]').value;
            const imageFile = itemElement.querySelector('[type="file"]').files[0];
            
            const formData = new FormData();
            formData.append('category_id', categoryId.startsWith('new-') ? '' : categoryId);
            formData.append('name', name);
            formData.append('price', price);
            formData.append('description', description);
            formData.append('stock', stock);
            
            if (imageFile) {
                formData.append('item_image', imageFile);
            }
            
            if (isNew) {
                formData.append('is_new', '1');
            } else {
                formData.append('item_id', itemId);
            }
            
            fetch('save_menu_item.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Menu item saved successfully!', 'success');
                    if (isNew) {
                        // Reload items to get proper IDs
                        loadMenuCategories();
                    }
                } else {
                    throw new Error(data.message || 'Failed to save menu item');
                }
            })
            .catch(error => {
                console.error('Error saving menu item:', error);
                showNotification(`Error: ${error.message}`, 'error');
            });
        }
        
        function deleteMenuItem(categoryId, itemId) {
            if (!confirm('Are you sure you want to delete this menu item?')) {
                return;
            }
            
            if (itemId.startsWith('new-')) {
                // Just remove from UI if it's a new item
                document.getElementById(`item-${itemId}`).remove();
                return;
            }
            
            fetch(`delete_menu_item.php?item_id=${itemId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Menu item deleted successfully!', 'success');
                    loadMenuCategories();
                } else {
                    throw new Error(data.message || 'Failed to delete menu item');
                }
            })
            .catch(error => {
                console.error('Error deleting menu item:', error);
                showNotification(`Error: ${error.message}`, 'error');
            });
        }
        
        // Orders management
        function loadOrders() {
            const status = document.getElementById('order-status-filter').value;
            const search = document.getElementById('order-search').value;
            
            fetch(`get_owner_orders.php?restaurant_id=${restaurantId}&status=${status}&search=${encodeURIComponent(search)}`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('orders-list');
                    container.innerHTML = '';
                    
                    if (data.success && data.data.length > 0) {
                        data.data.forEach(order => {
                            const orderElement = document.createElement('div');
                            orderElement.className = 'order-card';
                            orderElement.innerHTML = `
                                <div class="order-header">
                                    <div class="order-id">Order #${order.id}</div>
                                    <div class="order-date">${new Date(order.order_date).toLocaleString()}</div>
                                    <div class="order-status status-${order.status}">
                                        ${order.status.charAt(0).toUpperCase() + order.status.slice(1)}
                                    </div>
                                </div>
                                
                                <div class="order-details">
                                    <div class="customer-info">
                                        <p><i class="fas fa-user"></i> ${order.user_name}</p>
                                        <p><i class="fas fa-phone"></i> ${order.user_phone || 'N/A'}</p>
                                        <p><i class="fas fa-map-marker-alt"></i> ${order.delivery_address}</p>
                                    </div>
                                    
                                    <div class="order-items">
                                        <h4>Items:</h4>
                                        <ul>
                                            ${order.items.split(',').map(item => `
                                                <li>${item.trim()}</li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                    
                                    <div class="order-total">
                                        <strong>Total:</strong> $${parseFloat(order.total_amount).toFixed(2)}
                                    </div>
                                    
                                    <div class="order-notes">
                                        ${order.special_instructions ? `
                                            <p><strong>Special Instructions:</strong> ${order.special_instructions}</p>
                                        ` : ''}
                                    </div>
                                </div>
                                
                                <div class="order-actions">
                                    ${order.status === 'pending' ? `
                                        <button class="btn btn-process" onclick="updateOrderStatus(${order.id}, 'processing')">
                                            <i class="fas fa-spinner"></i> Start Processing
                                        </button>
                                    ` : ''}
                                    
                                    ${order.status === 'processing' ? `
                                        <button class="btn btn-deliver" onclick="updateOrderStatus(${order.id}, 'delivered')">
                                            <i class="fas fa-truck"></i> Mark as Delivered
                                        </button>
                                    ` : ''}
                                    
                                    ${order.status === 'pending' || order.status === 'processing' ? `
                                        <button class="btn btn-cancel" onclick="updateOrderStatus(${order.id}, 'cancelled')">
                                            <i class="fas fa-times"></i> Cancel Order
                                        </button>
                                    ` : ''}
                                </div>
                            `;
                            container.appendChild(orderElement);
                        });
                    } else {
                        container.innerHTML = '<p>No orders found matching your criteria.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading orders:', error);
                    showNotification('Failed to load orders. Please try again.', 'error');
                });
        }
        
        function updateOrderStatus(orderId, newStatus) {
            if (!confirm(`Are you sure you want to change this order's status to "${newStatus}"?`)) {
                return;
            }
            
            fetch('update_order_status.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    order_id: orderId,
                    status: newStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Order status updated to ${newStatus}`, 'success');
                    loadOrders();
                } else {
                    throw new Error(data.message || 'Failed to update order status');
                }
            })
            .catch(error => {
                console.error('Error updating order status:', error);
                showNotification(`Error: ${error.message}`, 'error');
            });
        }
        
        // Offers management
        function loadOffers() {
            fetch(`get_offers.php?restaurant_id=${restaurantId}`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('offers-container');
                    container.innerHTML = '';
                    
                    if (data.success && data.data.length > 0) {
                        data.data.forEach(offer => {
                            addOfferToUI(offer);
                        });
                    } else {
                        container.innerHTML = '<p>No special offers found. Add your first offer!</p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading offers:', error);
                    showNotification('Failed to load offers. Please try again.', 'error');
                });
        }
        
        function addOfferToUI(offerData = null) {
            const offerId = offerData ? offerData.id : `new-${Date.now()}`;
            const container = document.getElementById('offers-container');
            
            const offerElement = document.createElement('div');
            offerElement.className = 'offer-card';
            offerElement.id = `offer-${offerId}`;
            offerElement.innerHTML = `
                <div class="offer-description">
                    <textarea placeholder="Offer description" data-offer-id="${offerId}">${offerData?.description || ''}</textarea>
                </div>
                
                <div class="offer-valid">
                    <label>Valid Until:</label>
                    <input type="date" value="${offerData?.valid_until || ''}" data-offer-id="${offerId}">
                </div>
                
                <div class="offer-actions">
                    <button class="btn btn-primary" onclick="saveOffer('${offerId}')">
                        <i class="fas fa-save"></i> Save
                    </button>
                    <button class="btn btn-danger" onclick="deleteOffer('${offerId}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            `;
            
            container.appendChild(offerElement);
        }
        
        function addOffer() {
            addOfferToUI();
        }
        
        function saveOffer(offerId) {
            const isNew = offerId.startsWith('new-');
            const offerElement = document.getElementById(`offer-${offerId}`);
            
            const description = offerElement.querySelector('textarea').value;
            const validUntil = offerElement.querySelector('input[type="date"]').value;
            
            const formData = new FormData();
            formData.append('restaurant_id', restaurantId);
            formData.append('description', description);
            formData.append('valid_until', validUntil);
            
            if (isNew) {
                formData.append('is_new', '1');
            } else {
                formData.append('offer_id', offerId);
            }
            
            fetch('save_offer.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Offer saved successfully!', 'success');
                    loadOffers();
                } else {
                    throw new Error(data.message || 'Failed to save offer');
                }
            })
            .catch(error => {
                console.error('Error saving offer:', error);
                showNotification(`Error: ${error.message}`, 'error');
            });
        }
        
        function deleteOffer(offerId) {
            if (!confirm('Are you sure you want to delete this offer?')) {
                return;
            }
            
            if (offerId.startsWith('new-')) {
                // Just remove from UI if it's a new offer
                document.getElementById(`offer-${offerId}`).remove();
                return;
            }
            
            fetch(`delete_offer.php?offer_id=${offerId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Offer deleted successfully!', 'success');
                    loadOffers();
                } else {
                    throw new Error(data.message || 'Failed to delete offer');
                }
            })
            .catch(error => {
                console.error('Error deleting offer:', error);
                showNotification(`Error: ${error.message}`, 'error');
            });
        }
        
        // Restaurant settings
        function loadRestaurantSettings() {
            fetch(`get_restaurant.php?id=${restaurantId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const restaurant = data.data;
                        
                        document.getElementById('restaurant-id').value = restaurant.id;
                        document.getElementById('restaurant-name').value = restaurant.name;
                        document.getElementById('restaurant-desc').value = restaurant.description;
                        document.getElementById('phone').value = restaurant.phone;
                        document.getElementById('address').value = restaurant.address;
                        document.getElementById('owner-name').value = restaurant.owner_name;
                        document.getElementById('owner-email').value = restaurant.owner_email;
                        
                        // Set image if exists
                        if (restaurant.image_path) {
                            document.getElementById('current-image').src = restaurant.image_path;
                            document.getElementById('current-image-container').style.display = 'block';
                        } else {
                            document.getElementById('current-image-container').style.display = 'none';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading restaurant settings:', error);
                    showNotification('Failed to load restaurant settings', 'error');
                });
        }
        
        // Save restaurant settings
        document.getElementById('restaurant-settings-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            submitBtn.disabled = true;
            
            fetch('update_restaurant.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Restaurant settings saved successfully!', 'success');
                    // Update owner name in localStorage and UI if changed
                    const newOwnerName = document.getElementById('owner-name').value;
                    localStorage.setItem('ownerName', newOwnerName);
                    document.getElementById('ownerName').textContent = newOwnerName;
                } else {
                    throw new Error(data.message || 'Failed to save settings');
                }
            })
            .catch(error => {
                console.error('Error saving restaurant settings:', error);
                showNotification(`Error: ${error.message}`, 'error');
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        });
        
        // Helper function to show notifications
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                ${message}
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
    </script>
</body>
</html>